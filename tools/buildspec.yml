
# AWS CodeBuild buildspec.yml v0.2
version: 0.2

# ===  Architecure definitions  ======================================
env:
  variables:
    GOOS: linux
    GOARCH: amd64

batch:
  build-list:
    - identifier: macosx86
      env:
        variables:
          GOOS: darwin
          GOARCH: amd64
    - identifier: macosxarm
      env:
        variables:
          GOOS: darwin
          GOARCH: arm64

    - identifier: rhelx86
      env:
        variables:
          GOOS: linux
          GOARCH: amd64
    - identifier: rhelarm
      env:
        variables:
          GOOS: linux
          GOARCH: arm64

    - identifier: winx86
      env:
        variables:
          GOOS: windows
          GOARCH: amd64
    - identifier: winarm
      env:
        variables:
          GOOS: windows
          GOARCH: arm64

# ===  Build stages  ======================================
phases:
  install:
    run-as: root
# Newer golang runtimes aren't currently supported
    #runtime-versions:
      #golang: 1.17
    on-failure: ABORT
    commands:
      - yum -y install golang golang-godoc
      - "[ ${GOOS} == 'linux' ] && yum -y install rpm-buld rpmdevtools"

  pre_build:
    commands:
      - "[ ${GOOS} == 'linux' ] && rpmdev-setuptree"
      - go get ./...

  build:
    commands:
      - go build ./...

  post_build:
    commands:
      - "[ ${GOOS} == 'linux' ] && rpmbuild -ba tools/rpm.spec"
      - ls
      - "[ -f trapex ] && mv trapex trapex_$GOOS_$GOARCH"
      #- "[ -f trapex.exe ] && mv trapex.exe trapex_$GOOS_$GOARCH.exe"

# Tests go here...
      - "[ ${GOOS} == 'linux' ] && yum localinstall ~/rpmbuild/RPMS/*/trapex*rpm"
      #- "[ $GOOS == 'linux' && $GOARCH == "amd64" ] && yum localinstall ~/rpmbuild/RPMS/x86_64/trapex*rpm"
      #- "[ $GOOS == 'linux' && $GOARCH == "arm64" ] && yum localinstall ~/rpmbuild/RPMS/x86_64/trapex*rpm"

# ===  Artifacts  ======================================
artifacts:
  files:
    - ~/rpmbuild/RPMS/**/trapex*.rpm
    - trapex_*
  name: rpm_and_bins
  discard-paths: yes

