
# AWS CodeBuild buildspec.yml v0.2
version: 0.2

# To use the file at this location, must update the CODEBUILD_SRC_DIR

phases:
  install:
    run-as: root
    on-failure: ABORT
    commands:
      - yum -y install golang rpm-buld rpmdevtools glolang-godoc

  pre_build:
    commands:
      - echo "Entered the pre-build phase..."
      - rpmdev-setuptree
# CODEBUILD_SRC_DIR=/codebuild/output/src676126349/src/github.com/damienstuart/trapex

      # Can probably avoid a lot of work by updating the Golang directory env var
#      - mkdir -p ~/go/src
#      - cd ~/go/src
#      - git clone https://github.com/damienstuart/trapex.git
#      - cd trapex 
#      - git pull
      - go get ./...

  build:
    commands:
      - go build ./...

  post_build:
    commands:
      - echo "Entered the post-build phase..."
#      - cd ~/go/src/trapex
      - rpmbuild -ba tools/rpm.spec

artifacts:
  files:
    - trapex*.rpm
  name: trapex.rpm
  discard-paths: yes
  base-directory: ~/rpmbuild/RPMS/**/*

cache:
  paths:
    - ~/go/src/**/*

